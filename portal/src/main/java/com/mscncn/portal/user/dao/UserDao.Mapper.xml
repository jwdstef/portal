<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper 
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<!-- 这里namespace必须是PostsMapper接口的路径，不然要运行的时候要报错 “is not known to the MapperRegistry”--> 
<mapper namespace="com.mscncn.portal.user.dao.UserDao"> 
	<insert id="save" parameterType="User">
		insert into
		s_user(user_id,username,password,salt,locked)
		values(#{userId},#{userName},#{password},#{salt},#{locked})
	</insert>
	<select id="getId" resultType="int" >
		select max(user_id)+1 from s_user
	</select>
	<select id="findUserByName" resultType="UserDetail" parameterType="java.lang.String">
		select 
			t.user_id as userId,
			t.username as userName,
			t.password as password,
			t.salt as salt,
			t.locked as locked,
			d.real_name as realName,
	        d.email as email,
	        d.phone as phone,
	        d.create_time as createTime,
	        d.last_login_time as lastLoginTime
		from s_user t,s_user_detail d 
		where t.user_id=d.user_id  
		<if test="userName!=null and userName!=''">
			and username=#{userName}
		</if>
	</select>
	<select id="findRolesByUserName" parameterType="java.lang.String"
		resultType="java.util.Set">
		select
			r.role_name
		from
			s_user u,
			s_user_role ur,
			s_role r
		where
			<if test="userName!=null and userName != ''">
				u.username = #{userName} and
			</if>
			ur.user_id = u.user_id
			and ur.role_id = r.role_id
	</select>
	<select id="findResourcesByUserName" parameterType="java.lang.String"
		resultType="java.util.Set">
		select
			r.resources_code
		from
			s_user u,
			s_user_role ur,
			s_role_resources rs,
			s_resources r
		where
			<if test="userName!=null and userName != ''">
				u.username = #{userName} and
			</if>
			ur.user_id = u.user_id
			and ur.role_id = rs.role_id
			and r.resources_id = rs.resources_id
	</select>
	<select id="getList" parameterType="Pagination"
		resultType="UserDetail">
		select 
			t.user_id as userId,
			t.username as userName,
			t.locked as locked,
			t.salt as salt,
			d.real_name as realName,
	        d.email as email,
	        d.phone as phone,
	        d.create_time as createTime,
	        d.last_login_time as lastLoginTime
		from s_user t,s_user_detail d 
		where t.user_id=d.user_id
	</select>
	<select id="getUserById" parameterType="java.lang.Integer"
		resultType="UserDetail">
		select 
			t.user_id as userId,
			t.username as userName,
			t.locked as locked,
			d.real_name as realName,
	        d.email as email,
	        d.phone as phone,
	        d.create_time as createTime,
	        d.last_login_time as lastLoginTime
		from s_user t,s_user_detail d 
		where t.user_id=d.user_id 
    	<if test="id!=null">
    		and t.user_id=#{id}
    	</if>
	</select>
	<delete id="deleteUser" parameterType="java.lang.String">
		delete from s_user where user_id in 
		<foreach collection="array" item="id" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>
	<update id="reSetPassword" parameterType="UserDetail">
		update s_user set password=#{password} where user_id=#{userId}
	</update>
	<update id="update" parameterType="UserDetail">
		update s_user 
			<set>
				<if test="password!=null and password!=''">
					password=#{password},
				</if>
				<if test="locked!=null">
					locked=#{locked}
				</if>
			</set>  
			<where>
				<if test="userId!=null">
					user_id=#{userId}
				</if>
			</where>
	</update>
</mapper>